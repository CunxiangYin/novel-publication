# 发布服务快速实施指南

## 1. 快速开始（5分钟）

### 步骤1: 创建项目目录
```bash
mkdir novel-publication-service
cd novel-publication-service
npm init -y
```

### 步骤2: 复制核心文件
```bash
# 创建目录结构
mkdir -p services routes config data/cache

# 从原项目复制核心文件
cp ~/shorstory/short_novel_write_v1/backend/services/novel_publication_service.js ./services/
cp ~/shorstory/short_novel_write_v1/backend/services/publication_cache_service.js ./services/
cp ~/shorstory/short_novel_write_v1/backend/services/workflow_output_scanner.js ./services/
cp ~/shorstory/short_novel_write_v1/backend/config/novel_categories.json ./config/
```

### 步骤3: 安装依赖
```bash
npm install express fs-extra cors helmet express-rate-limit dotenv
```

### 步骤4: 创建服务器文件
创建 `server.js`:
```javascript
const express = require('express');
const cors = require('cors');
const helmet = require('helmet');
const crypto = require('crypto');
const path = require('path');
require('dotenv').config();

const app = express();
const PORT = process.env.PORT || 3000;

// 中间件
app.use(helmet());
app.use(cors());
app.use(express.json({ limit: '10mb' }));

// 初始化服务
const NovelPublicationService = require('./services/novel_publication_service');
const publicationService = new NovelPublicationService(path.join(__dirname, 'data'));

// 签名验证中间件
function verifySignature(req, res, next) {
  if (process.env.SKIP_SIGNATURE === 'true') {
    return next();
  }
  
  const signature = req.headers['x-signature'];
  const date = new Date().toISOString().slice(0, 10).replace(/-/g, '');
  const expected = crypto.createHash('md5')
    .update(date + 'aiGenerateBook')
    .digest('hex');
  
  if (signature !== expected) {
    return res.status(401).json({
      success: false,
      error: '签名验证失败'
    });
  }
  next();
}

// 路由
app.post('/api/publish/generate', verifySignature, async (req, res) => {
  try {
    const { projectId, content, metadata, options } = req.body;
    
    // 如果提供了直接内容，创建临时项目
    if (content && !projectId) {
      const tempId = `temp_${Date.now()}`;
      const tempDir = path.join(__dirname, 'data', 'projects', tempId);
      await require('fs-extra').ensureDir(tempDir);
      await require('fs-extra').writeFile(
        path.join(tempDir, 'content.md'),
        content
      );
      
      const result = await publicationService.generatePublicationData(tempId, {
        sourceFile: 'content.md',
        ...metadata,
        ...options
      });
      
      // 清理临时文件
      await require('fs-extra').remove(tempDir);
      
      return res.json(result);
    }
    
    // 使用已有项目
    const result = await publicationService.generatePublicationData(
      projectId,
      { ...metadata, ...options }
    );
    res.json(result);
    
  } catch (error) {
    res.status(500).json({
      success: false,
      error: error.message
    });
  }
});

app.post('/api/publish/submit', verifySignature, async (req, res) => {
  try {
    const { publicationData, target } = req.body;
    
    // 验证数据
    publicationService.validatePublicationData(publicationData);
    
    // 发布到目标平台
    const endpoint = target?.endpoint || 
      'https://wxrd.alongmen.com/book/v1/uploadBookInfo';
    
    const result = await publicationService.publishToWeChat(
      publicationData,
      endpoint
    );
    
    res.json(result);
    
  } catch (error) {
    res.status(500).json({
      success: false,
      error: error.message
    });
  }
});

app.get('/api/health', (req, res) => {
  res.json({
    status: 'healthy',
    service: 'novel-publication',
    version: '1.0.0',
    timestamp: new Date().toISOString()
  });
});

app.listen(PORT, () => {
  console.log(`发布服务运行在端口 ${PORT}`);
  console.log(`健康检查: http://localhost:${PORT}/api/health`);
});
```

### 步骤5: 创建环境配置
创建 `.env` 文件:
```bash
PORT=3000
NODE_ENV=production
SKIP_SIGNATURE=false
```

### 步骤6: 启动服务
```bash
node server.js
```

## 2. 测试服务

### 生成签名的辅助脚本
创建 `generate-signature.js`:
```javascript
const crypto = require('crypto');

function generateSignature() {
  const date = new Date().toISOString().slice(0, 10).replace(/-/g, '');
  const signature = crypto.createHash('md5')
    .update(date + 'aiGenerateBook')
    .digest('hex');
  console.log(signature);
  return signature;
}

generateSignature();
```

### 测试请求示例
```bash
# 获取签名
SIGNATURE=$(node generate-signature.js)

# 测试生成发布数据
curl -X POST http://localhost:3000/api/publish/generate \
  -H "Content-Type: application/json" \
  -H "X-Signature: $SIGNATURE" \
  -d '{
    "content": "# 测试小说\n\n## 第一章\n\n这是测试内容...",
    "metadata": {
      "title": "测试作品",
      "author": "测试作者"
    }
  }'
```

## 3. Docker快速部署

### 创建Dockerfile
```dockerfile
FROM node:16-alpine
WORKDIR /app
COPY package*.json ./
RUN npm ci --only=production
COPY . .
EXPOSE 3000
CMD ["node", "server.js"]
```

### 构建和运行
```bash
# 构建镜像
docker build -t novel-publication-service .

# 运行容器
docker run -d \
  -p 3000:3000 \
  -v $(pwd)/data:/app/data \
  --name publication-service \
  novel-publication-service
```

## 4. 核心功能清单

### 必需功能（MVP）
- [x] MD5签名生成和验证
- [x] 章节解析（支持多种格式）
- [x] 元数据提取（标题、作者、简介）
- [x] 精彩片段提取
- [x] 分类映射
- [x] 数据验证
- [x] 发布到微信接口

### 增强功能
- [ ] AI智能生成（需要LLM服务）
- [ ] 缓存机制
- [ ] 批量发布
- [ ] 发布历史
- [ ] 多平台支持

## 5. API快速参考

### 生成发布数据
```http
POST /api/publish/generate
X-Signature: {md5_signature}

{
  "content": "小说markdown内容",
  "metadata": {
    "title": "可选标题",
    "author": "可选作者"
  }
}
```

### 发布到平台
```http
POST /api/publish/submit
X-Signature: {md5_signature}

{
  "publicationData": {
    "title": "作品标题",
    "intro": "简介",
    "author": "作者",
    "firstCategory": "男频",
    "secondCategory": "都市",
    "thirdCategory": "都市生活",
    "completeStatus": 2,
    "awesomeParagraph": "精彩片段",
    "chapterList": []
  }
}
```

## 6. 故障排查

### 常见问题

**Q: 签名验证失败**
```bash
# 检查日期是否正确
date +%Y%m%d
# 确保使用正确的密钥: aiGenerateBook
```

**Q: 章节解析失败**
```javascript
// 支持的章节格式
第一章、第二章...
Chapter 1、Chapter 2...
## 第一章
### 第一节
```

**Q: 内存溢出**
```bash
# 增加Node内存限制
node --max-old-space-size=4096 server.js
```

## 7. 性能优化建议

### 生产环境配置
```javascript
// 使用PM2管理进程
// ecosystem.config.js
module.exports = {
  apps: [{
    name: 'publication-service',
    script: 'server.js',
    instances: 2,
    exec_mode: 'cluster',
    env: {
      NODE_ENV: 'production',
      PORT: 3000
    }
  }]
};
```

### 启动命令
```bash
pm2 start ecosystem.config.js
pm2 save
pm2 startup
```

## 8. 监控集成

### 添加日志
```javascript
// 使用winston记录日志
const winston = require('winston');

const logger = winston.createLogger({
  level: 'info',
  format: winston.format.json(),
  transports: [
    new winston.transports.File({ filename: 'error.log', level: 'error' }),
    new winston.transports.File({ filename: 'combined.log' })
  ]
});
```

### 健康检查端点
```bash
# 用于监控系统
curl http://localhost:3000/api/health
```

## 9. 安全加固

### 限流配置
```javascript
const rateLimit = require('express-rate-limit');

const limiter = rateLimit({
  windowMs: 60 * 1000, // 1分钟
  max: 100 // 限制100个请求
});

app.use('/api/', limiter);
```

### HTTPS配置
```javascript
const https = require('https');
const fs = require('fs');

const options = {
  key: fs.readFileSync('private-key.pem'),
  cert: fs.readFileSync('certificate.pem')
};

https.createServer(options, app).listen(443);
```

## 10. 下一步

1. **功能扩展**
   - 添加更多平台适配器
   - 实现AI生成功能
   - 增加格式转换支持

2. **性能优化**
   - 实现Redis缓存
   - 添加CDN支持
   - 优化大文件处理

3. **运维改进**
   - 配置自动化部署
   - 添加监控告警
   - 实现灰度发布

---

## 联系支持
- 文档位置: `/backend/docs/`
- 核心服务: `/backend/services/novel_publication_service.js`
- 配置文件: `/backend/config/novel_categories.json`

最后更新: 2025-01-14